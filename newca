#!/bin/sh

usage() {
  e=$1
  echo Usage:
  echo "  $(basename $0) [-h|--help]"
  echo "    This help"
  echo "  $(basename $0) [-c <Signing CA>] [-d <CRL_URL>] <CA>"
  echo "    Create CA with CRL distribution CRL_URL"
  echo "    -c: Create the CA as a sub-CA of the given CA"
  if [ "$e" ]; then exit $e; fi
}

unset CA subca

if [ "$1" = "--help" ]; then usage 0; fi
while getopts "c:d:" arg; do
  case $arg in
    c) CA=$OPTARG subca=1 ;;
    d) CRL_URL=$OPTARG ;;
    h) usage 0 ;;
    ?) usage 1 ;;
  esac
done
shift $(expr $OPTIND - 1)

NEWCA="$1"
if [ -z "$CA" ]; then CA="$NEWCA"; fi
if [ -z "$NEWCA" ]; then usage 1; fi
export NEWCA CA CRL_URL

cd ${PKIDIR:-/srv/pki}
if [ -e "$NEWCA" ]; then
  echo CA "$NEWCA" already exists. >&2
  exit 2
fi
if ! tmp=$(mktemp -d); then
  echo Cannot create temporary directory. >&2
  exit -1
fi
trap "rm -fr $tmp" EXIT

set -e

export default_o="${default_o:-$NEWCA}"
export default_ou=${default_ou:-PKI${subca:+:$CA}}
export default_cn=${default_cn:-${subca:+Sub-}CA}
mkdir "$NEWCA" "$NEWCA/certificates" "$NEWCA/keys" "$NEWCA/requests"
echo 01 > "$NEWCA/serial"
touch "$NEWCA/index"
if [ -n "$subca" ]; then
  newkey -s -e -c "$CA" "$NEWCA"
  sign -s -c "$CA" "$NEWCA"
  cp "$CA/keys/$NEWCA" "$NEWCA/keys/CA"
  cp "$CA/certificates/$NEWCA" "$NEWCA/certificates/CA"
else
  openssl genrsa -out $tmp/key 4096
  openssl rsa -in $tmp/key -des3 -text -out "$CA/keys/CA"
  openssl req -config pki.conf -new -x509 -key $tmp/key -text -out "$CA/certificates/CA"
  openssl ca -config pki.conf -gencrl -keyfile $tmp/key -cert "$CA/certificates/CA" | openssl crl -text -out "$CA/crl"
fi

